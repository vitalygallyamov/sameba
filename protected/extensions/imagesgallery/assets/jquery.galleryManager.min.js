(function(e){function n(n,r){function d(e){return String(e).replace(/&/g,"&").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function v(t,n,r,s){var o='<div class="photo-editor">'+'<div class="preview"><img src="'+d(n)+'" alt=""/></div>'+"<div>"+(i.hasName?'<label for="photo_name_'+t+'">'+i.nameLabel+":</label>"+'<input type="text" name="photo['+t+'][name]" class="input-xlarge" value="'+d(r)+'" id="photo_name_'+t+'"/>':"")+(i.hasDesc?'<label for="photo_description_'+t+'">'+i.descriptionLabel+":</label>"+'<textarea name="photo['+t+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+t+'">'+d(s)+"</textarea>":"")+"</div>"+"</div>";return e(o)}function g(t,n,r,s,u,a){var l=e(m);o[t]=l;l.data("id",t);l.data("rank",u);e("img",l).attr("src",n);if(i.hasName)e(".caption h5",l).text(r);if(i.hasDesc)e(".caption p",l).text(s);if(a=="1")e(".mainPhoto",l).addClass("disabled");f.append(l);return l}function y(t){var n=t.length;var r=p.empty();for(var i=0;i<n;i++){var s=t[i];var u=o[s],a=e("img",u).attr("src"),f=e(".caption h5",u).text(),c=e(".caption p",u).text();r.append(v(s,a,f,c))}if(n>0)l.modal("show")}function b(t){e.ajax({type:"POST",url:i.deleteUrl,data:"id[]="+t.join("&id[]=")+s,success:function(e){if(e=="OK"){for(var n=0,r=t.length;n<r;n++){o[t[n]].remove();delete o[t[n]]}}else alert(e)}})}function w(t){t.preventDefault();var n=e(this).closest(".photo");var r=n.data("id");b([r]);return false}function E(t){t.preventDefault();var n=e(this).closest(".photo");var r=n.data("id");y([r]);return false}function S(t){t.preventDefault();if(!e(this).hasClass("disabled")){var n=e(this).closest(".images");var r=e(this).closest(".photo");var o=r.data("id");var u=[];e(".photo",a).each(function(){u.push(e(this).data("id"))});n.find(".mainPhoto").removeClass("disabled");e(this).addClass("disabled");e.ajax({type:"POST",url:i.changeMainUrl,data:"main_id="+o+"&id[]="+u.join("&id[]=")+s,success:function(e){}})}return false}function x(){var t=e(".photo.selected",a).length;e(".select_all",u).prop("checked",e(".photo",a).length==t);if(t==0){e(".edit_selected, .remove_selected",u).addClass("disabled")}else{e(".edit_selected, .remove_selected",u).removeClass("disabled")}}function T(){var t=e(this);if(t.is(":checked"))t.closest(".photo").addClass("selected");else t.closest(".photo").removeClass("selected");x()}var i=e.extend({},t,r);var s=i.csrfToken?"&"+i.csrfTokenName+"="+i.csrfToken:"";var o={};var u=e(n);if(!i.hasName){if(!i.hasDesc){u.addClass("no-name-no-desc");e(".edit_selected",u).hide()}else u.addClass("no-name")}else if(!i.hasDesc)u.addClass("no-desc");var a=e(".sorter",u);var f=e(".images",a);var l=e(".editor-modal",u);var c=e(".progress-overlay",u);var h=e(".upload-progress",c);var p=e(".form",l);var m='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(i.hasName)m+="<h5></h5>";if(i.hasDesc)m+="<p></p>";m+='</div><div class="actions">';m+='<span class="mainPhoto btn btn-success btn-mini"><i class="icon-star icon-white"></i></span> ';if(i.hasName||i.hasDesc)m+='<span class="editPhoto btn btn-primary btn-mini"><i class="icon-pencil icon-white"></i></span> ';m+='<span class="deletePhoto btn btn-danger btn-mini"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';f.on("click",".photo .deletePhoto",w).on("click",".photo .editPhoto",E).on("click",".photo .mainPhoto",S).on("click",".photo .photo-select",T);e(".images",a).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var t=[];e(".photo",a).each(function(){var n=e(this);t.push("order["+n.data("id")+"]="+n.data("rank"))});e.ajax({type:"POST",url:i.arrangeUrl,data:t.join("&")+s,dataType:"json"}).done(function(e){for(var t in e[t]){o[t].data("rank",e[t])}})});if(window.FormData!==undefined){var N=e(".afile",u).attr("name");function C(e){c.show();h.css("width","5%");var t=e.length;var n=0;var r=[];for(var s=0;s<t;s++){var o=new FormData;o.append(N,e[s]);if(i.csrfToken){o.append(i.csrfTokenName,i.csrfToken)}var u=new XMLHttpRequest;u.open("POST",i.uploadUrl,true);u.onload=function(){n++;if(this.status==200){var e=JSON.parse(this.response);g(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["main"]);r.push(e["id"])}else{}h.css("width",""+(5+95*n/t)+"%");if(n===t){h.css("width","100%");c.hide();if(i.hasName||i.hasDesc)y(r)}if(f.find("span.disabled").length==0){f.find(".photo").eq(0).find(".mainPhoto").click()}};u.send(o)}}(function(){function r(e){e.preventDefault();t=true;return false}function i(){t=false;return false}function s(e){e.preventDefault();e.stopPropagation();var n=e.dataTransfer.files;C(n);t=false;return false}function o(){t=false}var e=u[0];var t=false;var n=false;setInterval(function(){if(t!=n){if(t)e.classList.add("over");else e.classList.remove("over");n=t}},30);e.addEventListener("dragover",r,false);e.addEventListener("dragleave",i,false);e.addEventListener("drop",s,false);e.addEventListener("dragend",o,false)})();e(".afile",u).attr("multiple","true").on("change",function(e){e.preventDefault();C(this.files)})}else{e(".afile",u).on("change",function(t){t.preventDefault();var n=[];c.show();h.css("width","5%");var r={};if(i.csrfToken)r[i.csrfTokenName]=i.csrfToken;e.ajax({type:"POST",url:i.uploadUrl,data:r,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){g(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["main"]);n.push(e["id"]);h.css("width","100%");c.hide();if(i.hasName||i.hasDesc)y(n);if(f.find("span.disabled").length==0){f.find(".photo").eq(0).find(".mainPhoto").click()}})})}e(".save-changes",l).click(function(t){t.preventDefault();e.post(i.updateUrl,e("input, textarea",p).serialize()+s,function(t){var n=t.length;for(var r=0;r<n;r++){var s=t[r];var f=o[s.id];e("img",f).attr("src",s["src"]);if(i.hasName)e(".caption h5",f).text(s["name"]);if(i.hasDesc)e(".caption p",f).text(s["description"])}l.modal("hide");e(".photo.selected",a).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",u).prop("checked",false);x()},"json")});e(".edit_selected",u).click(function(t){t.preventDefault();var n=[];e(".photo.selected",a).each(function(){n.push(e(this).data("id"))});y(n);return false});e(".remove_selected",u).click(function(t){t.preventDefault();var n=[];e(".photo.selected",a).each(function(){n.push(e(this).data("id"))});b(n)});e(".select_all",u).change(function(){if(e(this).prop("checked")){e(".photo",a).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",a).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}x()});for(var k=0,L=i.photos.length;k<L;k++){var A=i.photos[k];g(A["id"],A["preview"],A["name"],A["description"],A["rank"],A["main"])}}var t={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",changeMainUrl:"",photos:[]};e.fn.galleryManager=function(e){if(this.length){this.each(function(){n(this,e)})}}})(jQuery)